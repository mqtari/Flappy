<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draw Pro Neon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-button-color: #00f2ff;
            --tg-theme-button-text-color: #ffffff;
            --bg-dark: #0f172a;
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.6);
            --glass: rgba(30, 41, 59, 0.8);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø²ÙˆÙ… ÙˆØ§Ù„Ù„ÙˆØ­Ø© */
        .board-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            overflow: auto; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø²ÙˆÙ… Ø§Ù„ÙƒØ¨ÙŠØ± */
        }

        .canvas-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 450px;
            max-height: 450px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), var(--neon-glow);
            border-radius: 12px;
            background: #fff;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
            touch-action: none;
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .controls {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(0, 242, 255, 0.2);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 2000;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        /* Ø³ØªØ§ÙŠÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙˆÙ… (Progress) */
        .zoom-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.05);
            padding: 5px 15px;
            border-radius: 20px;
            width: 90%;
            margin: 0 auto;
        }
        
        #zoomSlider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #334155;
            border-radius: 5px;
            outline: none;
        }
        
        #zoomSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--tg-theme-button-color);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--neon-glow);
        }

        .circle-switch {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0, 242, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--tg-theme-button-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .circle-switch.active {
            background: var(--tg-theme-button-color);
            color: #000;
            box-shadow: var(--neon-glow);
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø¬Ù… */
        .thickness-panel {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--glass);
            padding: 10px 5px;
            border-radius: 15px;
            border: 1px solid rgba(0,242,255,0.3);
            z-index: 1000;
        }

        #sizeSlider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 120px;
        }

        .shape-dialog {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 20px;
            padding: 20px;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            z-index: 10000;
        }

        #btnSend {
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            color: white;
            font-weight: bold;
            flex: 1;
            max-width: 120px;
        }

        .label-text { font-size: 10px; color: var(--tg-theme-button-color); margin-bottom: 5px; }

    </style>
</head>
<body>

    <div class="board-container">
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· (1-50) -->
        <div class="thickness-panel">
            <span class="label-text">Ø­Ø¬Ù…</span>
            <span id="sizeValue" style="font-size: 12px; font-weight: bold;">10</span>
            <input type="range" id="sizeSlider" min="1" max="50" value="10">
        </div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="mainCanvas" width="1000" height="1000"></canvas>
            <canvas id="tempCanvas" width="1000" height="1000"></canvas>
        </div>
    </div>

    <div class="controls">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø²ÙˆÙ… (Ù†ÙØ³ ÙÙƒØ±Ø© Ø§Ù„Ø¨Ø±ÙˆØ¬Ø±Ø³) -->
        <div class="zoom-control">
            <span style="font-size: 12px;">ğŸ”</span>
            <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1">
            <div class="circle-switch" id="btnResetZoom" style="width: 30px; height: 30px; font-size: 10px;">Reset</div>
        </div>

        <div class="controls-row">
            <div class="circle-switch active" id="toolPencil">âœï¸</div>
            <div class="circle-switch" id="toolEraser">ğŸ§½</div>
            <div class="circle-switch" id="toolFill">ğŸ«—</div>
            <div class="circle-switch" id="toolColor">
                <input type="color" id="colorPicker" value="#000000" style="position:absolute; opacity:0; width:40px; height:40px; cursor:pointer">
                <div id="colorShow" style="width:20px; height:20px; border-radius:50%; background:#000; border:2px solid #fff"></div>
            </div>
            <div class="circle-switch" id="btnShapes">ğŸ“</div>
        </div>

        <div class="controls-row">
            <div class="circle-switch" id="btnUndo">â†©ï¸</div>
            <div class="circle-switch" id="btnRedo">â†ªï¸</div>
            <div class="circle-switch" id="btnClear" style="color: #ff4444">ğŸ—‘ï¸</div>
            <div class="circle-switch" id="btnSend">Ø¥Ø±Ø³Ø§Ù„</div>
        </div>
    </div>

    <div id="shapeDialog" class="shape-dialog">
        <div class="circle-switch" data-shape="square">â¬œ</div>
        <div class="circle-switch" data-shape="circle">âšª</div>
        <div class="circle-switch" data-shape="triangle">ğŸ”º</div>
        <div class="circle-switch" data-shape="line">â–</div>
    </div>

    <script>
        const CONFIG = {
            BOT_TOKEN: 'Ø¶Ø¹_ØªÙˆÙƒÙ†_Ø§Ù„Ø¨ÙˆØª',
            IMGBB_KEY: 'Ø¶Ø¹_Ù…ÙØªØ§Ø­_IMGBB'
        };

        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const tempCanvas = document.getElementById('tempCanvas');
        const tctx = tempCanvas.getContext('2d');
        const wrapper = document.getElementById('canvasWrapper');
        
        let drawing = false;
        let tool = 'pencil';
        let color = '#000000';
        let size = 10;
        let zoom = 1;
        let undoStack = [];
        let redoStack = [];
        let startPos = { x: 0, y: 0 };
        let activeShape = 'square';

        function init() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            saveState();
        }

        // ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„Ù„Ù…Ø³ Ù…Ø¹ Ø§Ù„Ø²ÙˆÙ…
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            // Ù†Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (1000x1000)
            return {
                x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                y: (touch.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > 30) undoStack.shift();
            redoStack = [];
        }

        // Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        canvas.addEventListener('touchstart', (e) => {
            drawing = true;
            startPos = getPos(e);
            if (tool === 'fill') {
                floodFill(startPos.x, startPos.y, color);
                saveState();
                drawing = false;
            } else if (tool !== 'shapes') {
                ctx.beginPath();
                ctx.moveTo(startPos.x, startPos.y);
            }
        });

        canvas.addEventListener('touchmove', (e) => {
            if (!drawing) return;
            const pos = getPos(e);
            
            if (tool === 'pencil' || tool === 'eraser') {
                ctx.strokeStyle = tool === 'eraser' ? 'white' : color;
                ctx.lineWidth = size;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            } else if (tool === 'shapes') {
                tctx.clearRect(0, 0, canvas.width, canvas.height);
                drawShape(tctx, startPos, pos);
            }
        });

        canvas.addEventListener('touchend', (e) => {
            if (!drawing) return;
            drawing = false;
            if (tool === 'shapes') {
                const pos = getPos(e.changedTouches[0]);
                drawShape(ctx, startPos, pos);
                tctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            saveState();
        });

        function drawShape(c, s, e) {
            c.strokeStyle = color;
            c.lineWidth = size;
            c.beginPath();
            const w = e.x - s.x;
            const h = e.y - s.y;
            if (activeShape === 'square') c.rect(s.x, s.y, w, h);
            else if (activeShape === 'circle') c.arc(s.x, s.y, Math.sqrt(w*w + h*h), 0, Math.PI*2);
            else if (activeShape === 'line') { c.moveTo(s.x, s.y); c.lineTo(e.x, e.y); }
            else if (activeShape === 'triangle') {
                c.moveTo(s.x + w/2, s.y);
                c.lineTo(s.x, s.y + h);
                c.lineTo(s.x + w, s.y + h);
                c.closePath();
            }
            c.stroke();
        }

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø­Ø¬Ù… (1-50)
        document.getElementById('sizeSlider').oninput = (e) => {
            size = e.target.value;
            document.getElementById('sizeValue').innerText = size;
        };

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø²ÙˆÙ… (Slider)
        const zoomSlider = document.getElementById('zoomSlider');
        zoomSlider.oninput = (e) => {
            zoom = e.target.value;
            wrapper.style.transform = `scale(${zoom})`;
        };

        // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø²ÙˆÙ…
        document.getElementById('btnResetZoom').onclick = () => {
            zoom = 1;
            zoomSlider.value = 1;
            wrapper.style.transform = `scale(1)`;
        };

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        document.getElementById('colorPicker').oninput = (e) => {
            color = e.target.value;
            document.getElementById('colorShow').style.background = color;
        };

        // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰
        document.getElementById('toolPencil').onclick = () => setTool('pencil');
        document.getElementById('toolEraser').onclick = () => setTool('eraser');
        document.getElementById('toolFill').onclick = () => setTool('fill');
        document.getElementById('btnUndo').onclick = () => {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                let img = new Image();
                img.src = undoStack[undoStack.length - 1];
                img.onload = () => { ctx.clearRect(0,0,1000,1000); ctx.drawImage(img,0,0); };
            }
        };
        document.getElementById('btnClear').onclick = () => { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©ØŸ")) init(); };

        function setTool(t) {
            tool = t;
            document.querySelectorAll('.circle-switch').forEach(el => el.classList.remove('active'));
            if(t==='pencil') document.getElementById('toolPencil').classList.add('active');
            if(t==='eraser') document.getElementById('toolEraser').classList.add('active');
            if(t==='fill') document.getElementById('toolFill').classList.add('active');
        }

        document.getElementById('btnShapes').onclick = () => {
            const d = document.getElementById('shapeDialog');
            d.style.display = d.style.display === 'grid' ? 'none' : 'grid';
        };

        document.querySelectorAll('[data-shape]').forEach(el => {
            el.onclick = () => {
                activeShape = el.dataset.shape;
                setTool('shapes');
                document.getElementById('btnShapes').classList.add('active');
                document.getElementById('shapeDialog').style.display = 'none';
            };
        });

        // Flood Fill Logic (Simplified)
        function floodFill(x, y, fillCol) {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            const startPos = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
            const targetR = data[startPos], targetG = data[startPos+1], targetB = data[startPos+2];
            const fillRGB = hexToRgb(fillCol);
            
            if (targetR === fillRGB[0] && targetG === fillRGB[1] && targetB === fillRGB[2]) return;

            const queue = [[Math.floor(x), Math.floor(y)]];
            while(queue.length > 0) {
                const [cx, cy] = queue.pop();
                const idx = (cy * canvas.width + cx) * 4;
                if (cx>=0 && cx<canvas.width && cy>=0 && cy<canvas.height && 
                    data[idx]===targetR && data[idx+1]===targetG && data[idx+2]===targetB) {
                    data[idx]=fillRGB[0]; data[idx+1]=fillRGB[1]; data[idx+2]=fillRGB[2]; data[idx+3]=255;
                    queue.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function hexToRgb(hex) {
            let r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            return [r, g, b];
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©
        document.getElementById('btnSend').onclick = async () => {
            const btn = document.getElementById('btnSend');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ...";
            try {
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                const fd = new FormData();
                fd.append('image', blob);
                fd.append('key', CONFIG.IMGBB_KEY);
                
                const res = await fetch('https://api.imgbb.com/1/upload', { method:'POST', body:fd });
                const data = await res.json();
                
                if(data.success) {
                    await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendPhoto`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            chat_id: tg.initDataUnsafe.user.id,
                            photo: data.data.url,
                            caption: "Ø±Ø³Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Draw Pro Neon âœ¨"
                        })
                    });
                    tg.close();
                }
            } catch (e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"); }
            btn.innerText = "Ø¥Ø±Ø³Ø§Ù„";
        };

        init();
    </script>
</body>
</html>
