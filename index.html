<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draw Pro Neon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-clr: #00f2ff;
            --bg: #0f172a;
            --glass: rgba(30, 41, 59, 0.95);
            --neon: 0 0 15px rgba(0, 242, 255, 0.6);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø© */
        .board {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            touch-action: none;
        }

        .canvas-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 450px;
            max-height: 450px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), var(--neon);
            border-radius: 12px;
            background: #fff;
            transform-origin: center;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
            border-radius: 12px;
            touch-action: none;
        }

        #tempCanvas { z-index: 5; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .controls {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-top: 2px solid rgba(0, 242, 255, 0.3);
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 9999; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
        }

        .row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(0, 242, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }

        .btn:active { transform: scale(0.9); }
        .btn.active { background: var(--tg-clr); color: #000; box-shadow: var(--neon); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .thickness-panel {
            position: absolute;
            right: 10px;
            top: 40%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--glass);
            padding: 15px 8px;
            border-radius: 20px;
            z-index: 9999;
            border: 1px solid rgba(0,242,255,0.3);
        }

        #sizeSlider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 12px;
            height: 130px;
        }

        /* Ø²ÙˆÙˆÙ… */
        .zoom-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.4);
            padding: 8px 15px;
            border-radius: 30px;
            width: 90%;
            margin: 0 auto;
        }
        #zoomSlider { flex: 1; accent-color: var(--tg-clr); }

        /* Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø§Øµ */
        #btnSave {
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            width: auto;
            padding: 0 25px;
            font-weight: bold;
            font-size: 16px;
            border: none;
            color: white;
        }

        .shape-dialog {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #1e293b;
            border: 2px solid var(--tg-clr);
            border-radius: 25px;
            padding: 20px;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            z-index: 10000;
        }

        input[type="color"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .color-circle { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #fff; background: #000; }

    </style>
</head>
<body>

    <div class="board">
        <div class="thickness-panel">
            <span style="font-size: 10px; color: var(--tg-clr); margin-bottom: 5px;">Ø­Ø¬Ù…</span>
            <input type="range" id="sizeSlider" min="1" max="70" value="10">
            <span id="sizeVal" style="margin-top:5px; font-weight:bold;">10</span>
        </div>

        <div class="canvas-container" id="wrapper">
            <canvas id="mainCanvas" width="1000" height="1000"></canvas>
            <canvas id="tempCanvas" width="1000" height="1000"></canvas>
        </div>
    </div>

    <div class="controls">
        <div class="zoom-bar">
            <span>ğŸ”</span>
            <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1">
            <div id="btnReset" style="font-size: 11px; color: #ff4444; cursor: pointer;">Ø¶Ø¨Ø· ğŸ”„</div>
        </div>

        <div class="row">
            <div class="btn active" id="toolPencil">âœï¸</div>
            <div class="btn" id="toolEraser">ğŸ§½</div>
            <div class="btn" id="toolPicker">ğŸ’§</div>
            <div class="btn" id="toolFill">ğŸ«—</div>
            <div class="btn">
                <input type="color" id="colorPicker">
                <div class="color-circle" id="colorShow"></div>
            </div>
            <div class="btn" id="btnShapeMenu">ğŸ“</div>
        </div>

        <div class="row">
            <div class="btn" id="btnUndo">â†©ï¸</div>
            <div class="btn" id="btnRedo">â†ªï¸</div>
            <div class="btn" id="btnClear">ğŸ—‘ï¸</div>
            <div class="btn" id="btnSave">Ø­ÙØ¸ Ø§Ù„Ø¬Ù‡Ø§Ø² ğŸ’¾</div>
        </div>
    </div>

    <div id="shapeDialog" class="shape-dialog">
        <div class="btn" data-shape="square">â¬œ</div>
        <div class="btn" data-shape="circle">âšª</div>
        <div class="btn" data-shape="triangle">ğŸ”º</div>
        <div class="btn" data-shape="line">â–</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d', {willReadFrequently:true});
        const tCanvas = document.getElementById('tempCanvas'), tctx = tCanvas.getContext('2d');
        const wrapper = document.getElementById('wrapper');
        
        let drawing = false, tool = 'pencil', color = '#000000', size = 10, zoom = 1, shape = 'square';
        let undoStack = [], redoStack = [], startPos = {x:0, y:0};

        function init() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, 1000, 1000);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            saveState();
        }

        function getPos(e) {
            const rect = tCanvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (1000 / rect.width),
                y: (e.clientY - rect.top) * (1000 / rect.height)
            };
        }

        function saveState() {
            undoStack.push(canvas.toDataURL());
            if(undoStack.length > 30) undoStack.shift();
            redoStack = [];
        }

        // --- Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø³Ù… ---
        tCanvas.addEventListener('pointerdown', (e) => {
            const pos = getPos(e);
            startPos = pos;
            if(tool === 'toolPicker') {
                const p = ctx.getImageData(pos.x, pos.y, 1, 1).data;
                const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1).toUpperCase();
                updateColor(hex); setTool('pencil'); return;
            }
            if(tool === 'fill') { floodFill(Math.floor(pos.x), Math.floor(pos.y), color); saveState(); return; }
            drawing = true;
            if(tool !== 'shape') { ctx.beginPath(); ctx.moveTo(pos.x, pos.y); }
        });

        window.addEventListener('pointermove', (e) => {
            if(!drawing) return;
            const pos = getPos(e);
            if(tool === 'pencil' || tool === 'eraser') {
                ctx.strokeStyle = tool === 'eraser' ? 'white' : color;
                ctx.lineWidth = size;
                ctx.lineTo(pos.x, pos.y); ctx.stroke();
            } else if(tool === 'shape') {
                tctx.clearRect(0,0,1000,1000);
                drawShape(tctx, startPos, pos);
            }
        });

        window.addEventListener('pointerup', (e) => {
            if(!drawing) return; drawing = false;
            if(tool === 'shape') { drawShape(ctx, startPos, getPos(e)); tctx.clearRect(0,0,1000,1000); }
            saveState();
        });

        function drawShape(c, s, e) {
            c.strokeStyle = color; c.lineWidth = size; c.beginPath();
            const w = e.x - s.x, h = e.y - s.y;
            if(shape==='square') c.rect(s.x, s.y, w, h);
            else if(shape==='circle') c.arc(s.x, s.y, Math.sqrt(w*w + h*h), 0, Math.PI*2);
            else if(shape==='line') { c.moveTo(s.x, s.y); c.lineTo(e.x, e.y); }
            else if(shape==='triangle') { c.moveTo(s.x+w/2, s.y); c.lineTo(s.x, s.y+h); c.lineTo(s.x+w, s.y+h); c.closePath(); }
            c.stroke();
        }

        // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ ---
        function setTool(t) {
            tool = t;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            const idMap = {pencil:'toolPencil', eraser:'toolEraser', toolPicker:'toolPicker', fill:'toolFill', shape:'btnShapeMenu'};
            const activeBtn = document.getElementById(idMap[t] || t);
            if(activeBtn) activeBtn.classList.add('active');
        }

        document.getElementById('toolPencil').onclick = () => setTool('pencil');
        document.getElementById('toolEraser').onclick = () => setTool('eraser');
        document.getElementById('toolPicker').onclick = () => setTool('toolPicker');
        document.getElementById('toolFill').onclick = () => setTool('fill');
        
        document.getElementById('btnShapeMenu').onclick = () => {
            const d = document.getElementById('shapeDialog');
            d.style.display = d.style.display === 'grid' ? 'none' : 'grid';
        };

        document.querySelectorAll('[data-shape]').forEach(b => {
            b.onclick = () => {
                shape = b.dataset.shape; setTool('shape');
                document.getElementById('shapeDialog').style.display = 'none';
            };
        });

        function updateColor(c) {
            color = c;
            document.getElementById('colorShow').style.background = c;
            document.getElementById('colorPicker').value = c;
        }

        document.getElementById('colorPicker').oninput = (e) => updateColor(e.target.value);
        document.getElementById('sizeSlider').oninput = (e) => {
            size = e.target.value; document.getElementById('sizeVal').innerText = size;
        };
        document.getElementById('zoomSlider').oninput = (e) => {
            zoom = e.target.value; wrapper.style.transform = `scale(${zoom})`;
        };

        document.getElementById('btnUndo').onclick = () => {
            if(undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const img = new Image(); img.src = undoStack[undoStack.length-1];
                img.onload = () => { ctx.clearRect(0,0,1000,1000); ctx.drawImage(img,0,0); };
            }
        };

        document.getElementById('btnRedo').onclick = () => {
            if(redoStack.length > 0) {
                const data = redoStack.pop(); undoStack.push(data);
                const img = new Image(); img.src = data;
                img.onload = () => { ctx.clearRect(0,0,1000,1000); ctx.drawImage(img,0,0); };
            }
        };

        document.getElementById('btnClear').onclick = () => { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø©ØŸ")) init(); };
        document.getElementById('btnReset').onclick = () => {
            init(); zoom = 1; wrapper.style.transform='scale(1)';
            document.getElementById('zoomSlider').value=1; updateColor("#000000"); setTool('pencil');
        };

        // --- Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ ---
        document.getElementById('btnSave').onclick = () => {
            const dataUrl = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = `Sketch_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => { tg.close(); }, 800);
        };

        function floodFill(x,y,fCol){
            const img=ctx.getImageData(0,0,1000,1000), d=img.data, i=(y*1000+x)*4;
            const sr=d[i], sg=d[i+1], sb=d[i+2];
            const rgb = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fCol).slice(1).map(x=>parseInt(x,16));
            if(sr===rgb[0]&&sg===rgb[1]&&sb===rgb[2]) return;
            const q=[[x,y]];
            while(q.length){
                const [cx,cy]=q.pop(); const p=(cy*1000+cx)*4;
                if(cx>=0&&cx<1000&&cy>=0&&cy<1000&&d[p]===sr&&d[p+1]===sg&&d[p+2]===sb){
                    d[p]=rgb[0]; d[p+1]=rgb[1]; d[p+2]=rgb[2]; d[p+3]=255;
                    q.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
                }
            } ctx.putImageData(img,0,0);
        }

        init();
    </script>
</body>
</html>
