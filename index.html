<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Draw Pro Neon</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-button-color: #00f2ff;
            --tg-theme-button-text-color: #ffffff;
            --bg-dark: #0f172a;
            --neon-glow: 0 0 15px rgba(0, 242, 255, 0.6);
            --glass: rgba(30, 41, 59, 0.8);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .board-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 10px;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            overflow: hidden; 
        }

        .canvas-container {
            position: relative;
            width: 95vw;
            height: 95vw;
            max-width: 500px;
            max-height: 500px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), var(--neon-glow);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            transition: transform 0.1s ease-out;
        }

        canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        .controls {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(0, 242, 255, 0.2);
            padding: 15px 10px 30px 10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 2000;
        }

        .controls-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px;
        }

        .circle-switch {
            width: 46px;
            height: 46px;
            min-width: 46px;
            border-radius: 35%;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--tg-theme-button-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--tg-theme-button-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .circle-switch.active {
            background: var(--tg-theme-button-color);
            color: #000;
            box-shadow: var(--neon-glow);
            transform: scale(1.1);
        }

        .circle-switch svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        .thickness-panel {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            background: var(--glass);
            padding: 15px 5px;
            border-radius: 20px;
            border: 1px solid rgba(0,242,255,0.3);
            z-index: 1000;
        }

        input[type="range"] {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 150px;
            background: #334155;
        }

        .shape-dialog {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 20px;
            padding: 20px;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            z-index: 10000;
        }

        #btnSend {
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            border: none;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
            width: 100px;
            border-radius: 15px;
        }

        /* ÿ≥ÿ™ÿßŸäŸÑ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ÿØŸäÿØÿ© */
        .save-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            z-index: 99999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .save-modal img {
            max-width: 90%;
            max-height: 70vh;
            border: 2px solid var(--tg-theme-button-color);
            box-shadow: var(--neon-glow);
            border-radius: 10px;
            margin-bottom: 20px;
            /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ */
            pointer-events: auto !important;
            user-select: auto !important; 
            -webkit-user-select: auto !important;
            -webkit-touch-callout: default !important;
        }

        .save-hint {
            color: #fff;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px #000;
        }

        .close-btn {
            padding: 10px 30px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }
    </style>
</head>
<body>

    <div class="board-container">
        <div class="thickness-panel">
            <span style="font-size: 10px; color: var(--tg-theme-button-color); margin-bottom:5px">ÿ≠ÿ¨ŸÖ</span>
            <input type="range" id="sizeSlider" min="2" max="60" value="10">
        </div>

        <div class="canvas-container" id="canvasWrapper">
            <canvas id="mainCanvas" width="1000" height="1000"></canvas>
            <canvas id="tempCanvas" width="1000" height="1000"></canvas>
        </div>
    </div>

    <div class="controls">
        <div class="controls-row">
            <div class="circle-switch active" id="toolPencil"><svg viewBox="0 0 512 512"><path d="M481 31C445.1-4.8 386.9-4.8 351 31l-15 15L322.9 33C294.8 4.9 249.2 4.9 221.1 33L135 119c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L255 66.9c9.4-9.4 24.6-9.4 33.9 0L302.1 80 186.3 195.7 316.3 325.7 481 161c35.9-35.9 35.9-94.1 0-129.9zM293.7 348.3L163.7 218.3 99.5 282.5c-48 48-80.8 109.2-94.1 175.8l-5 25c-1.6 7.9 .9 16 6.6 21.7s13.8 8.1 21.7 6.6l25-5c66.6-13.3 127.8-46.1 175.8-94.1l64.2-64.2z"/></svg></div>
            <div class="circle-switch" id="toolEraser"><svg viewBox="0 0 512 512"><path d="M497.9 210.1l-160-160c-18.7-18.7-49.1-18.7-67.9 0l-256 256c-18.7 18.7-18.7 49.1 0 67.9l96 96c9.4 9.4 22.1 14.7 35.4 14.7H480c6.6 0 12-5.4 12-12v-40c0-6.6-5.4-12-12-12H355.9l142-142c18.8-18.8 18.8-49.2 0-68z"/></svg></div>
            <div class="circle-switch" id="toolFill"><svg viewBox="0 0 512 512"><path d="M512 320s-64 92.7-64 128c0 35.3 28.66 64 64 64s64-28.66 64-64c0-35.3-64-128-64-128zM9.4 206.4l201-201c12.5-12.5 32.8-12.5 45.3 0l221.6 221.6c12.5 12.5 12.5 32.8 0 45.3L256 493.6c-12.5 12.5-32.8 12.5-45.3 0L9.4 271.7c-12.5-12.5-12.5-32.8 0-45.3z"/></svg></div>
            <div class="circle-switch" id="btnUndo"><svg viewBox="0 0 512 512"><path d="M212.3 224.3l99 99c4.7 4.7 4.7 12.3 0 17l-22.6 22.6c-4.7 4.7-12.3 4.7-17 0l-144.2-144c-4.7-4.7-4.7-12.3 0-17l144.2-144c4.7-4.7 12.3-4.7 17 0l22.6 22.6c4.7 4.7 4.7 12.3 0 17l-99 99h235.7c6.6 0 12 5.4 12 12v32c0 6.6-5.4 12-12 12H212.3z"/></svg></div>
            <div class="circle-switch" id="btnRedo"><svg viewBox="0 0 512 512"><path d="M299.7 224.3l-99 99c-4.7 4.7-4.7 12.3 0 17l22.6 22.6c4.7 4.7 12.3 4.7 17 0l144.2-144c4.7-4.7 4.7-12.3 0-17l-144.2-144c-4.7-4.7-12.3-4.7-17 0l-22.6 22.6c-4.7 4.7-4.7 12.3 0 17l99 99H64c-6.6 0-12 5.4-12 12v32c0 6.6 5.4 12 12 12h235.7z"/></svg></div>
        </div>

        <div class="controls-row">
            <div class="circle-switch" id="btnClear" style="border-color: #ff4444; color: #ff4444"><svg viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64s14.3 32 32 32h384c17.7 0 32-14.3 32-32s-14.3-32-32-32h-96l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32l21.2 339c1.6 25.3 22.6 45 47.9 45h246.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg></div>
            <div class="circle-switch" id="btnShapes"><svg viewBox="0 0 512 512"><path d="M256 56L64 456h384L256 56zm0 82l138 278H118l138-278z"/></svg></div>
            <div class="circle-switch" id="toolColor"><input type="color" id="colorPicker" value="#000000" style="width:100%; height:100%; opacity:0; cursor:pointer"><div id="colorShow" style="width:24px; height:24px; border-radius:50%; background:#000; border:1px solid #fff"></div></div>
            
            <div class="circle-switch" id="btnZoomIn">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7h-1v2.5H6.5v1h2.5V13h1v-2.5H12.5v-1H10V7z"/></svg>
            </div>
            <div class="circle-switch" id="btnZoomOut">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z"/></svg>
            </div>
            
            <div class="circle-switch" id="btnSend"><span>ÿ≠ŸÅÿ∏</span></div>
        </div>
    </div>

    <div id="shapeDialog" class="shape-dialog">
        <div class="circle-switch" data-shape="square">‚¨ú</div>
        <div class="circle-switch" data-shape="circle">‚ö™</div>
        <div class="circle-switch" data-shape="triangle">üî∫</div>
        <div class="circle-switch" data-shape="line">‚ûñ</div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
    <div id="saveModal" class="save-modal">
        <div class="save-hint">üëá ÿßÿ∂ÿ∫ÿ∑ ŸÖÿ∑ŸàŸÑÿßŸã ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ© ŸÑÿ≠ŸÅÿ∏Ÿáÿß üëá</div>
        <img id="finalImage" src="" alt="ÿ±ÿ≥ŸÖÿ™Ÿä">
        <button class="close-btn" onclick="document.getElementById('saveModal').style.display='none'">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const tempCanvas = document.getElementById('tempCanvas');
        const tctx = tempCanvas.getContext('2d');
        
        let drawing = false;
        let tool = 'pencil';
        let color = '#000000';
        let size = 10;
        let startPos = { x: 0, y: 0 };
        let undoStack = [];
        let redoStack = [];
        let activeShape = 'square';
        let zoom = 1;

        function init() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            saveState();
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            return {
                x: (touch.clientX - rect.left) * (canvas.width / rect.width),
                y: (touch.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function saveState() {
            undoStack.push(canvas.toDataURL());
            if (undoStack.length > 30) undoStack.shift();
            redoStack = [];
        }

        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const img = new Image();
                img.src = undoStack[undoStack.length - 1];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const state = redoStack.pop();
                undoStack.push(state);
                const img = new Image();
                img.src = state;
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function start(e) {
            drawing = true;
            startPos = getPos(e);
            if (tool !== 'shapes' && tool !== 'fill') {
                ctx.beginPath();
                ctx.moveTo(startPos.x, startPos.y);
            }
        }

        function move(e) {
            if (!drawing) return;
            const pos = getPos(e);
            if (tool === 'pencil' || tool === 'eraser') {
                ctx.strokeStyle = tool === 'eraser' ? 'white' : color;
                ctx.lineWidth = size;
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            } else if (tool === 'shapes') {
                tctx.clearRect(0, 0, canvas.width, canvas.height);
                drawShape(tctx, startPos, pos);
            }
        }

        function end(e) {
            if (!drawing) return;
            drawing = false;
            if (tool === 'shapes') {
                const pos = getPos(e.changedTouches ? {touches:[e.changedTouches[0]]} : e);
                drawShape(ctx, startPos, pos);
                tctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            saveState();
        }

        function drawShape(c, s, e) {
            c.strokeStyle = color;
            c.lineWidth = size;
            c.beginPath();
            const w = e.x - s.x;
            const h = e.y - s.y;
            if (activeShape === 'square') c.rect(s.x, s.y, w, h);
            else if (activeShape === 'circle') c.arc(s.x, s.y, Math.sqrt(w*w + h*h), 0, Math.PI*2);
            else if (activeShape === 'line') { c.moveTo(s.x, s.y); c.lineTo(e.x, e.y); }
            else if (activeShape === 'triangle') {
                c.moveTo(s.x + w/2, s.y);
                c.lineTo(s.x, s.y + h);
                c.lineTo(s.x + w, s.y + h);
                c.closePath();
            }
            c.stroke();
        }

        function floodFill(x, y, fillCol) {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            const basePos = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
            const target = [data[basePos], data[basePos+1], data[basePos+2], data[basePos+3]];
            const fill = hexToRgb(fillCol);
            if (target[0] === fill[0] && target[1] === fill[1] && target[2] === fill[2]) return;
            
            const queue = [[Math.floor(x), Math.floor(y)]];
            while(queue.length) {
                const [cx, cy] = queue.shift();
                const i = (cy * canvas.width + cx) * 4;
                if (cx < 0 || cx >= canvas.width || cy < 0 || cy >= canvas.height) continue;
                if (data[i]===target[0] && data[i+1]===target[1] && data[i+2]===target[2]) {
                    data[i]=fill[0]; data[i+1]=fill[1]; data[i+2]=fill[2]; data[i+3]=255;
                    queue.push([cx+1, cy], [cx-1, cy], [cx, cy+1], [cx, cy-1]);
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1,3), 16);
            const g = parseInt(hex.slice(3,5), 16);
            const b = parseInt(hex.slice(5,7), 16);
            return [r, g, b];
        }

        document.getElementById('toolPencil').onclick = () => setTool('pencil');
        document.getElementById('toolEraser').onclick = () => setTool('eraser');
        document.getElementById('toolFill').onclick = () => setTool('fill');
        document.getElementById('btnUndo').onclick = undo;
        document.getElementById('btnRedo').onclick = redo;
        document.getElementById('btnShapes').onclick = () => {
            const d = document.getElementById('shapeDialog');
            d.style.display = d.style.display === 'grid' ? 'none' : 'grid';
        };

        function setTool(t) {
            tool = t;
            document.querySelectorAll('.circle-switch').forEach(el => el.classList.remove('active'));
            if(t==='pencil') document.getElementById('toolPencil').classList.add('active');
            if(t==='eraser') document.getElementById('toolEraser').classList.add('active');
            if(t==='fill') document.getElementById('toolFill').classList.add('active');
            if(t==='shapes') document.getElementById('btnShapes').classList.add('active');
        }

        document.querySelectorAll('[data-shape]').forEach(el => {
            el.onclick = () => {
                activeShape = el.dataset.shape;
                setTool('shapes');
                document.getElementById('shapeDialog').style.display = 'none';
            };
        });

        document.getElementById('colorPicker').oninput = (e) => {
            color = e.target.value;
            document.getElementById('colorShow').style.background = color;
        };

        document.getElementById('sizeSlider').oninput = (e) => size = e.target.value;
        
        document.getElementById('btnClear').onclick = () => {
            if(confirm("ŸÖÿ≥ÿ≠ ÿßŸÑŸÑŸàÿ≠ÿ©ÿü")) init();
        };

        const updateZoom = () => {
            document.getElementById('canvasWrapper').style.transform = `scale(${zoom})`;
        };

        document.getElementById('btnZoomIn').onclick = () => {
            zoom = Math.min(zoom + 0.2, 5.0);
            updateZoom();
        };

        document.getElementById('btnZoomOut').onclick = () => {
            zoom = Math.max(zoom - 0.2, 0.5);
            updateZoom();
        };

        // -------------------------------------------------------------------
        //  ÿßŸÑÿ≠ŸÑ ÿßŸÑŸÜŸáÿßÿ¶Ÿä: ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ŸàÿßŸÑÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ∑ŸàŸÑ
        // -------------------------------------------------------------------
        document.getElementById('btnSend').onclick = () => {
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ŸÑÿµŸàÿ±ÿ©
            const dataUrl = canvas.toDataURL('image/png');
            // Ÿàÿ∂ÿπ ÿßŸÑÿµŸàÿ±ÿ© ŸÅŸä ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ≠ŸÅÿ∏
            const imgElement = document.getElementById('finalImage');
            imgElement.src = dataUrl;
            // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
            document.getElementById('saveModal').style.display = 'flex';
        };

        tempCanvas.addEventListener('touchstart', (e) => {
            if(tool === 'fill') {
                const pos = getPos(e);
                floodFill(pos.x, pos.y, color);
                saveState();
            } else start(e);
        });
        tempCanvas.addEventListener('touchmove', move);
        tempCanvas.addEventListener('touchend', end);

        init();
    </script>
</body>
</html>
