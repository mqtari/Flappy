<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- Ù…ÙƒØªØ¨Ø© Socket.IO Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<title>Codenames</title>
<style>
    :root { --bg: #111; --red: #e74c3c; --blue: #3498db; --neutral: #dcdcdc; --black: #2c3e50; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Tahoma', sans-serif; }
    body { margin: 0; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* Dashboard */
    .dashboard { height: 25%; display: flex; padding: 5px; gap: 5px; background: #222; }
    .team-col { flex: 1; border-radius: 8px; padding: 5px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; opacity: 0.5; border: 2px solid transparent; }
    .team-red { background: linear-gradient(45deg, #5c241e, #922b21); }
    .team-blue { background: linear-gradient(45deg, #1a3c52, #21618c); }
    .active { opacity: 1; transform: scale(1.02); border-color: #fff; }
    .score { font-size: 1.8rem; font-weight: bold; }
    .role-btn { font-size: 0.6rem; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 10px; margin-top: 2px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2); width: 100%; text-align: center; }
    .role-btn.taken { background: #7ed321; color: black; border-color: #7ed321; }

    /* Logs */
    .logs { height: 12%; background: #1a1a1a; overflow-y: auto; font-size: 0.7rem; padding: 5px; border-top: 1px solid #333; border-bottom: 1px solid #333; }
    .log-item { margin-bottom: 2px; }

    /* Grid */
    .grid { flex: 1; padding: 5px; display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr); gap: 4px; }
    .card { 
        background: var(--neutral); color: #333; border-radius: 4px; 
        display: flex; justify-content: center; align-items: center; 
        text-align: center; font-weight: bold; font-size: 0.65rem; 
        cursor: pointer; position: relative; transition: 0.3s;
        box-shadow: inset 0 -3px 0 rgba(0,0,0,0.2);
    }
    
    .card.revealed { color: white !important; cursor: default; transform: rotateY(180deg); }
    .card.revealed.red { background: var(--red); }
    .card.revealed.blue { background: var(--blue); }
    .card.revealed.black { background: var(--black); border: 2px solid white; }
    .card.revealed.neutral { background: #95a5a6; color: #eee !important; opacity: 0.4; }

    /* Spymaster View */
    .spy-view .card:not(.revealed).red { border: 3px solid var(--red); background: #333; color: var(--red); }
    .spy-view .card:not(.revealed).blue { border: 3px solid var(--blue); background: #333; color: var(--blue); }
    .spy-view .card:not(.revealed).black { border: 3px solid #777; background: #000; color: #aaa; }
    .spy-view .card:not(.revealed).neutral { border: 1px dashed #555; background: #222; color: #777; }

    /* Controls */
    .controls { height: 12%; background: #252525; padding: 5px; display: flex; align-items: center; justify-content: center; gap: 5px; }
    input, select { padding: 10px; border-radius: 20px; border: none; text-align: center; outline: none; }
    input { flex: 1; background: #fff; color: #000; }
    button { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; color: white; }
    .btn-go { background: #2ecc71; }
    .btn-pass { background: #e74c3c; width: 100%; }
    .hidden { display: none !important; }
</style>
</head>
<body>

<div class="dashboard">
    <div id="team-red" class="team-col team-red">
        <div class="score" id="score-red">0</div>
        <div class="role-btn" id="btn-red_spy" onclick="joinRole('red_spy')">Ù‚Ø§Ø¦Ø¯ Ø£Ø­Ù…Ø±</div>
        <div class="role-btn" id="btn-red_op" onclick="joinRole('red_op')">Ø¹Ù…ÙŠÙ„ Ø£Ø­Ù…Ø±</div>
    </div>
    <div id="team-blue" class="team-col team-blue">
        <div class="score" id="score-blue">0</div>
        <div class="role-btn" id="btn-blue_spy" onclick="joinRole('blue_spy')">Ù‚Ø§Ø¦Ø¯ Ø£Ø²Ø±Ù‚</div>
        <div class="role-btn" id="btn-blue_op" onclick="joinRole('blue_op')">Ø¹Ù…ÙŠÙ„ Ø£Ø²Ø±Ù‚</div>
    </div>
</div>

<div class="logs" id="logs"></div>
<div class="grid" id="grid"></div>

<div class="controls">
    <div id="start-btn" class="hidden"><button class="btn-go" onclick="sendAction('start')">Ø§Ø¶ØºØ· Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button></div>
    <div id="spy-controls" class="hidden" style="display:flex; width:100%; gap:5px;">
        <input type="text" id="clueTxt" placeholder="ØªÙ„Ù…ÙŠØ­">
        <select id="clueNum"><option>1</option><option>2</option><option>3</option><option>âˆ</option></select>
        <button class="btn-go" onclick="sendClue()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
    <div id="op-controls" class="hidden" style="width:100%">
        <button class="btn-pass" onclick="sendAction('pass')">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</button>
    </div>
    <div id="wait-msg" style="color:#777; font-size:0.8rem;">...</div>
</div>

<script>
    // Ù‚Ø±Ø§Ø¡Ø© Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„Ù‡ Ø§Ù„Ø¨ÙˆØª
    const urlParams = new URLSearchParams(window.location.search);
    const ROOM_ID = urlParams.get('r');
    const SERVER_URL = urlParams.get('host'); // Ø§Ù„Ø¨ÙˆØª ÙŠØ±Ø³Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

    let socket;
    let tgUser = {id: Math.floor(Math.random()*100000), first_name: 'Guest'};
    let gameState = null;
    let myRole = null;

    // ØªÙ‡ÙŠØ¦Ø© ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    if (window.Telegram.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        if(window.Telegram.WebApp.initDataUnsafe.user) 
            tgUser = window.Telegram.WebApp.initDataUnsafe.user;
    }

    if (SERVER_URL && ROOM_ID) {
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        socket = io(SERVER_URL);
        
        socket.on('connect', () => {
            socket.emit('join_game', { room: ROOM_ID, uid: tgUser.id });
        });

        socket.on('update', (data) => {
            gameState = data;
            render();
        });
    } else {
        document.body.innerHTML = "<h3 style='text-align:center;color:white;margin-top:50px'>Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª</h3>";
    }

    // --- Logic ---
    function joinRole(role) {
        socket.emit('action', { 
            room: ROOM_ID, type: 'join_role', 
            role: role, uid: tgUser.id, name: tgUser.first_name 
        });
    }

    function sendAction(type, extra={}) {
        socket.emit('action', { room: ROOM_ID, type: type, ...extra });
    }

    function sendClue() {
        const txt = document.getElementById('clueTxt').value;
        const num = document.getElementById('clueNum').value;
        if(!txt) return;
        sendAction('clue', { text: txt, num: num });
        document.getElementById('clueTxt').value = '';
    }

    function clickCard(i) {
        // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹
        if(!myRole || !myRole.includes('op')) return;
        const myTeam = myRole.split('_')[0];
        if(gameState.turn !== myTeam || gameState.phase !== 'op') return;
        
        sendAction('click', { idx: i });
    }

    function render() {
        // 1. Scores & Active Team
        document.getElementById('score-red').innerText = gameState.scores.red;
        document.getElementById('score-blue').innerText = gameState.scores.blue;
        document.getElementById('team-red').className = `team-col team-red ${gameState.turn==='red'?'active':''}`;
        document.getElementById('team-blue').className = `team-col team-blue ${gameState.turn==='blue'?'active':''}`;

        // 2. Roles
        myRole = null;
        for (const [role, player] of Object.entries(gameState.players)) {
            const btn = document.getElementById(`btn-${role}`);
            if (player) {
                btn.innerText = player.name;
                btn.classList.add('taken');
                if(player.id === tgUser.id) myRole = role;
            } else {
                btn.innerText = role.includes('spy') ? 'Ù‚Ø§Ø¦Ø¯' : 'Ø¹Ù…ÙŠÙ„';
                btn.classList.remove('taken');
            }
        }

        // 3. Spymaster View
        if (myRole && myRole.includes('spy')) document.body.classList.add('spy-view');
        else document.body.classList.remove('spy-view');

        // 4. Grid
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        gameState.cards.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = `card ${c.type} ${c.revealed ? 'revealed' : ''}`;
            div.innerText = c.word;
            if(c.revealed && c.type==='black') div.innerText = "â˜ ï¸";
            div.onclick = () => clickCard(i);
            grid.appendChild(div);
        });

        // 5. Controls
        const spyControls = document.getElementById('spy-controls');
        const opControls = document.getElementById('op-controls');
        const startBtn = document.getElementById('start-btn');
        const waitMsg = document.getElementById('wait-msg');
        
        spyControls.classList.add('hidden');
        opControls.classList.add('hidden');
        startBtn.classList.add('hidden');
        waitMsg.classList.remove('hidden');
        waitMsg.innerText = "Ø§Ù†ØªØ¸Ø± Ø¯ÙˆØ±Ùƒ...";

        if (!gameState.started) {
            waitMsg.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...";
            // Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ ÙŠØ¸Ù‡Ø± Ù„Ø£ÙŠ Ø´Ø®Øµ Ø¥Ø°Ø§ Ù„Ù… ØªØ¨Ø¯Ø£
            startBtn.classList.remove('hidden');
        } else if (myRole) {
            const myTeam = myRole.split('_')[0];
            const roleType = myRole.split('_')[1];
            
            if (gameState.turn === myTeam) {
                if (gameState.phase === 'spy' && roleType === 'spy') {
                    spyControls.classList.remove('hidden');
                    waitMsg.classList.add('hidden');
                } else if (gameState.phase === 'op' && roleType === 'op') {
                    opControls.classList.remove('hidden');
                    waitMsg.classList.add('hidden');
                }
            }
        }

        // 6. Logs
        const logs = document.getElementById('logs');
        logs.innerHTML = gameState.logs.map(l => {
            const color = l.team==='red'?'#e74c3c':'#3498db';
            if(l.type === 'clue') return `<div style="color:${color}">ğŸ’¡ ${l.text} (${l.num})</div>`;
            return `<div>ğŸ¯ ÙƒØ´Ù: ${l.word}</div>`;
        }).join('');
    }
</script>
</body>
</html>
